# VAD 기능 마이그레이션 및 적용 계획

## 개요
korean-ai-tutor 프로젝트의 VAD(Voice Activity Detection) 기능을 korean-learning-app으로 마이그레이션하여 **실시간 발화 구간 감지**를 통해 STT 비용과 지연시간을 최소화하는 계획입니다.

## 현재 상황 분석

### korean-ai-tutor의 VAD 구현 현황
- **VAD 엔진**: ONNX 기반 Silero VAD 모델 사용
- **모델 파일**: `/public/models/silero-vad.onnx`
- **핵심 파일들**:
  - `lib/audio/vad/VadConfig.ts` - VAD 설정 및 기본값
  - `lib/audio/vad/VadEngine.ts` - ONNX 런타임 세션 관리, 상태머신, 이벤트 처리
  - `lib/audio/vad/wav.ts` - PCM Float32 → 16-bit PCM → WAV 변환
  - `hooks/use-vad.tsx` - React 훅 인터페이스
  - `contexts/VadContext.tsx` - VAD 컨텍스트 제공자
  - `components/materials/VadPipeline.tsx` - VAD 파이프라인 컴포넌트
  - `public/audio-worklets/vad-processor.js` - 오디오 워크렛 프로세서

### korean-learning-app의 현재 오디오 처리
- **현재 방식**: MediaRecorder 기반 수동 녹음
- **문제점**: 
  - 전체 오디오를 STT 요청하여 비용 증가
  - 배경 소음이나 침묵 구간도 포함하여 STT 정확도 저하
  - 긴 오디오로 인한 STT 지연시간 증가

## 마이그레이션 계획

### 🎯 핵심 전략: 실시간 VAD + 기존 녹음 방식 유지
- **사용자 경험**: 기존 수동 녹음 버튼 방식 그대로 유지
- **VAD 역할**: 녹음 중 실시간으로 발화 구간 감지 및 추출
- **최적화**: 발화 구간만 STT 요청하여 비용과 지연시간 최소화

### 1단계: 핵심 VAD 파일 복사 및 설정
- [ ] `lib/audio/vad/` 디렉토리 생성 및 파일 복사
  - VadConfig.ts
  - VadEngine.ts  
  - wav.ts
- [ ] `public/models/silero-vad.onnx` 모델 파일 복사
- [ ] `public/audio-worklets/vad-processor.js` 워크렛 파일 복사
- [ ] `package.json`에 onnxruntime-web 의존성 추가

### 2단계: React 인터페이스 구현
- [ ] `hooks/use-vad.tsx` 훅 생성
- [ ] `contexts/VadContext.tsx` 컨텍스트 생성
- [ ] VAD 상태 관리 및 이벤트 처리 로직 구현

### 3단계: conversation-practice.tsx 통합
- [ ] **기존 녹음 로직 유지**: MediaRecorder 기반 수동 녹음 그대로 사용
- [ ] **VAD 백그라운드 실행**: 녹음 중 실시간으로 발화 구간 감지
- [ ] **발화 구간 버퍼링**: 감지된 발화 구간들을 메모리에 임시 저장
- [ ] **녹음 완료 시 처리**: 모든 발화 구간을 순서대로 STT 처리
- [ ] **UI 피드백**: 실시간 발화 감지 상태 표시

### 4단계: UI/UX 개선
- [ ] **실시간 상태 표시**: "Listening...", "Speaking detected" 등
- [ ] **발화 구간 시각화**: 감지된 발화 구간 개수 표시
- [ ] **오디오 레벨 미터**: 실시간 오디오 레벨 표시
- [ ] **에러 상태 처리**: VAD 실패 시 폴백 로직

## 기술적 세부사항

### VAD 설정 파라미터
```typescript
const vadConfig = {
  sampleRateTarget: 16000,
  frameMs: 30,
  speechProbabilityThreshold: 0.5,
  startSpeechAfterMs: 90,
  endSilenceAfterMs: 500,
  prefixPaddingMs: 300,
  maxUtteranceMs: 12000,
  minUtteranceMs: 250,
}
```

### 🎯 실시간 VAD + 녹음 통합 파이프라인

#### 처리 플로우
```
사용자 녹음 시작 (기존 버튼)
    ↓
VAD 엔진 시작 (백그라운드)
    ↓
실시간 발화 감지 → 발화 구간 버퍼에 저장
    ↓
침묵 감지 → 발화 구간 완료
    ↓
사용자 녹음 종료 (기존 버튼)
    ↓
모든 발화 구간을 순서대로 STT 처리
    ↓
결과 텍스트 결합하여 최종 응답
```

#### 기술적 구현
1. **듀얼 오디오 스트림**: 
   - MediaRecorder: 전체 오디오 녹음 (기존 방식)
   - VAD Engine: 실시간 발화 구간 감지 (새로운 기능)

2. **발화 구간 버퍼링**:
   - 발화 시작/종료 시점 기록
   - 각 발화 구간을 별도 WAV 파일로 저장
   - 시간 순서대로 정렬하여 관리

3. **STT 최적화**:
   - 전체 오디오 대신 발화 구간만 STT 요청
   - 각 발화 구간별로 병렬 STT 처리 가능
   - 결과 텍스트를 시간 순서로 결합

#### 상태 관리
- **녹음 상태**: 기존 MediaRecorder 상태 유지
- **VAD 상태**: 실시간 발화 감지 상태 추가
- **발화 구간**: 감지된 발화 구간들 배열로 관리
- **처리 상태**: STT 처리 진행 상황 표시

## 구현 우선순위

### 높은 우선순위
1. **핵심 VAD 엔진 마이그레이션** - 기본 기능 동작
2. **실시간 VAD + 녹음 통합** - 기존 녹음 방식과 VAD 동시 실행
3. **발화 구간 추출 및 STT 최적화** - 비용과 지연시간 최소화

### 중간 우선순위
4. **실시간 UI 피드백** - 발화 감지 상태 표시
5. **에러 처리 및 폴백** - VAD 실패 시 기존 방식으로 폴백
6. **성능 최적화** - 메모리 및 CPU 사용량 최적화

### 낮은 우선순위
7. **고급 UI 기능** - 발화 구간 시각화, 디버그 패널
8. **설정 커스터마이징** - 환경별 VAD 파라미터 조정
9. **분석 및 모니터링** - 발화 품질 분석

## 예상 이슈 및 해결방안

### 기술적 이슈
- **ONNX 모델 로딩 실패**: 에너지 기반 폴백 구현
- **오디오 권한 거부**: 사용자 가이드 및 재시도 로직
- **브라우저 호환성**: Web Audio API 지원 확인

### 성능 이슈
- **메모리 사용량**: 오디오 버퍼 관리 최적화
- **CPU 사용량**: 프레임 처리 간격 조정
- **네트워크**: 모델 파일 캐싱 전략

### UX 이슈
- **발화 감지 민감도**: 환경별 설정 조정
- **지연 시간**: 실시간 피드백 최적화
- **에러 복구**: 사용자 친화적 에러 메시지

## 성공 기준

### 기능적 요구사항
- [ ] **기존 녹음 방식 유지**: 사용자 경험 변경 없음
- [ ] **실시간 발화 감지**: 녹음 중 발화 구간 자동 감지
- [ ] **다중 발화 처리**: 하나의 녹음에서 여러 발화 구간 모두 감지
- [ ] **순서 보장**: 발화 구간들이 시간 순서대로 처리
- [ ] **STT 최적화**: 발화 구간만 STT 요청하여 비용 절약
- [ ] **폴백 동작**: VAD 실패 시 기존 방식으로 자동 전환

### 성능 요구사항
- [ ] **모델 로딩 시간** < 3초
- [ ] **발화 감지 지연** < 200ms
- [ ] **STT 처리 시간** 50% 이상 단축 (발화 구간만 처리)
- [ ] **STT 비용** 60% 이상 절약 (전체 오디오 대비)
- [ ] **메모리 사용량** < 100MB
- [ ] **CPU 사용량** < 30%

### 사용자 경험 요구사항
- [ ] **기존 UX 유지**: 녹음 버튼 방식 그대로 사용
- [ ] **실시간 피드백**: 발화 감지 상태 즉시 표시
- [ ] **명확한 상태**: "Listening...", "Speaking detected" 등
- [ ] **에러 복구**: VAD 실패 시 자동으로 기존 방식 전환

## 마이그레이션 체크리스트

### 파일 복사
- [ ] `lib/audio/vad/VadConfig.ts`
- [ ] `lib/audio/vad/VadEngine.ts`
- [ ] `lib/audio/vad/wav.ts`
- [ ] `public/models/silero-vad.onnx`
- [ ] `public/audio-worklets/vad-processor.js`

### 의존성 추가
- [ ] `onnxruntime-web` 패키지 설치
- [ ] TypeScript 타입 정의 확인

### 코드 통합
- [ ] `hooks/use-vad.tsx` 생성
- [ ] `contexts/VadContext.tsx` 생성
- [ ] `conversation-practice.tsx` 수정
- [ ] **기존 MediaRecorder 로직 유지** + VAD 백그라운드 추가
- [ ] 실시간 발화 구간 감지 및 버퍼링 로직 구현
- [ ] 발화 구간별 STT 처리 로직 구현

### 테스트
- [ ] **VAD 기본 동작 테스트**: 실시간 발화 감지 정확도
- [ ] **다중 발화 테스트**: 하나의 녹음에서 여러 발화 구간 감지
- [ ] **순서 보장 테스트**: 발화 구간들이 시간 순서대로 처리
- [ ] **STT 최적화 테스트**: 발화 구간만 STT 요청하여 비용 절약 확인
- [ ] **폴백 테스트**: VAD 실패 시 기존 방식으로 자동 전환
- [ ] **성능 테스트**: STT 처리 시간 및 비용 절약 효과 측정
- [ ] **브라우저 호환성 테스트**: 다양한 브라우저에서 동작 확인

## 장기 계획

### 추가 기능
- **다국어 지원**: 다른 언어의 VAD 모델 지원
- **음성 인식 개선**: 더 정확한 발화 구간 감지
- **실시간 분석**: 발화 품질 분석 및 피드백
- **오프라인 지원**: 로컬 VAD 처리

### 성능 최적화
- **모델 경량화**: 더 작은 VAD 모델 사용
- **스트리밍 처리**: 실시간 오디오 스트리밍
- **캐싱 전략**: 모델 및 오디오 데이터 캐싱
- **병렬 처리**: 멀티스레드 오디오 처리

## 🎯 핵심 혜택

### 사용자 경험
- **기존 UX 유지**: 녹음 버튼 방식 그대로 사용
- **실시간 피드백**: 발화 감지 상태 즉시 표시
- **자동 최적화**: 사용자가 신경 쓸 필요 없이 자동으로 최적화

### 기술적 혜택
- **STT 비용 60% 절약**: 발화 구간만 STT 요청
- **처리 시간 50% 단축**: 불필요한 침묵 구간 제거
- **정확도 향상**: 노이즈 제거로 STT 품질 개선
- **확장성**: 향후 실시간 대화 기능으로 확장 가능

이 계획을 통해 korean-learning-app에 **실시간 VAD 기능을 통한 STT 최적화**를 성공적으로 통합할 수 있을 것입니다.